
import { BlobServiceClient, StorageSharedKeyCredential, generateBlobSASQueryParameters, BlobSASPermissions, ContainerClient } from "@azure/storage-blob";

export function getStorageConfig() {
  const accountName = process.env.AZURE_STORAGE_ACCOUNT_NAME;
  const accountKey = process.env.AZURE_STORAGE_ACCOUNT_KEY;
  const containerName = process.env.AZURE_STORAGE_CONTAINER_NAME;

  if (!accountName || !accountKey || !containerName) {
    throw new Error("Azure Storage configuration is missing. Please set AZURE_STORAGE_ACCOUNT_NAME, AZURE_STORAGE_ACCOUNT_KEY, and AZURE_STORAGE_CONTAINER_NAME environment variables.");
  }

  return {
    accountName,
    accountKey,
    containerName,
  };
}

export function createBlobServiceClient(): BlobServiceClient {
  const { accountName, accountKey } = getStorageConfig();
  
  const sharedKeyCredential = new StorageSharedKeyCredential(accountName, accountKey);
  const blobServiceClient = new BlobServiceClient(
    `https://${accountName}.blob.core.windows.net`,
    sharedKeyCredential
  );
  
  return blobServiceClient;
}

export function getContainerClient(): ContainerClient {
  const blobServiceClient = createBlobServiceClient();
  const { containerName } = getStorageConfig();
  return blobServiceClient.getContainerClient(containerName);
}

export async function uploadFile(buffer: Buffer, fileName: string): Promise<string> {
  try {
    const containerClient = getContainerClient();
    const blobName = `uploads/${Date.now()}-${fileName}`;
    const blockBlobClient = containerClient.getBlockBlobClient(blobName);
    
    const contentType = getContentType(fileName);
    
    await blockBlobClient.uploadData(buffer, {
      blobHTTPHeaders: {
        blobContentType: contentType,
      }
    });
    
    return blobName; // Return cloud_storage_path
  } catch (error) {
    console.error("Error uploading file to Azure Blob Storage:", error);
    throw new Error("File upload failed");
  }
}

export async function downloadFile(blobName: string): Promise<string> {
  try {
    const { accountName, accountKey, containerName } = getStorageConfig();
    const sharedKeyCredential = new StorageSharedKeyCredential(accountName, accountKey);
    
    const containerClient = getContainerClient();
    const blobClient = containerClient.getBlobClient(blobName);
    
    // Generate SAS token for secure download (expires in 1 hour)
    const startsOn = new Date();
    const expiresOn = new Date(startsOn);
    expiresOn.setHours(startsOn.getHours() + 1);
    
    const sasToken = generateBlobSASQueryParameters(
      {
        containerName,
        blobName,
        permissions: BlobSASPermissions.parse("r"), // read permission
        startsOn,
        expiresOn,
      },
      sharedKeyCredential
    ).toString();
    
    const sasUrl = `${blobClient.url}?${sasToken}`;
    return sasUrl;
  } catch (error) {
    console.error("Error generating download URL:", error);
    throw new Error("File download failed");
  }
}

export async function deleteFile(blobName: string): Promise<void> {
  try {
    const containerClient = getContainerClient();
    const blockBlobClient = containerClient.getBlockBlobClient(blobName);
    
    await blockBlobClient.delete();
  } catch (error) {
    console.error("Error deleting file from Azure Blob Storage:", error);
    throw new Error("File deletion failed");
  }
}

export async function renameFile(oldBlobName: string, newBlobName: string): Promise<string> {
  try {
    const containerClient = getContainerClient();
    
    // Download the blob
    const oldBlobClient = containerClient.getBlobClient(oldBlobName);
    const downloadResponse = await oldBlobClient.download();
    
    if (!downloadResponse.readableStreamBody) {
      throw new Error("File not found");
    }
    
    // Convert stream to buffer
    const chunks: Buffer[] = [];
    for await (const chunk of downloadResponse.readableStreamBody) {
      chunks.push(Buffer.from(chunk));
    }
    const buffer = Buffer.concat(chunks);
    
    // Upload with new name
    const newBlobClient = containerClient.getBlockBlobClient(newBlobName);
    await newBlobClient.uploadData(buffer, {
      blobHTTPHeaders: downloadResponse.blobType ? {
        blobContentType: downloadResponse.contentType,
      } : undefined,
    });
    
    // Delete old blob
    await deleteFile(oldBlobName);
    
    return newBlobName;
  } catch (error) {
    console.error("Error renaming file in Azure Blob Storage:", error);
    throw new Error("File rename failed");
  }
}

function getContentType(fileName: string): string {
  const ext = fileName.toLowerCase().split('.').pop();
  switch (ext) {
    case 'pdf':
      return 'application/pdf';
    case 'png':
      return 'image/png';
    case 'jpg':
    case 'jpeg':
      return 'image/jpeg';
    case 'tiff':
    case 'tif':
      return 'image/tiff';
    default:
      return 'application/octet-stream';
  }
}
